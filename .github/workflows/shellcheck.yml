name: ShellCheck & Code Quality

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - '**.sh'
      - 'lib/**'
      - '.github/workflows/shellcheck.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.sh'
      - 'lib/**'

jobs:
  shellcheck:
    name: ShellCheck Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          echo "Installing ShellCheck..."
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck
          shellcheck --version
          echo "✓ ShellCheck installed"

      - name: Find shell scripts
        id: find_scripts
        run: |
          echo "Finding shell scripts..."
          scripts=$(find . -name "*.sh" -type f ! -path "./docs/*" ! -path "./.git/*" | sort)
          echo "Found scripts:"
          echo "$scripts"
          echo "script_count=$(echo "$scripts" | wc -l)" >> $GITHUB_OUTPUT

      - name: Run ShellCheck
        run: |
          echo "Running ShellCheck on all scripts..."
          echo "Options: -e SC1090 -e SC1091 -S warning"
          echo "Timeout: 30 seconds per file"
          echo ""

          # First, do a quick dry run with timeout
          echo "=== ShellCheck Issues Found ==="
          for script in install_multi.sh lib/*.sh; do
            if [[ -f "$script" ]]; then
              echo "Checking $script (timeout: 30s)..."

              # Use timeout to prevent hanging
              if timeout 30s shellcheck -e SC1090 -e SC1091 -S warning "$script" 2>&1; then
                echo "  ✓ No issues"
              else
                exit_status=$?
                if [[ $exit_status -eq 124 ]]; then
                  echo "  ⚠ TIMEOUT - shellcheck hung on this file"
                fi
              fi
              echo ""
            fi
          done
          echo "=== End of Issues ==="
          echo ""

          # Now do the actual check with exit codes and timeout
          exit_code=0
          count=0
          timeout_count=0

          for script in install_multi.sh lib/*.sh; do
            if [[ -f "$script" ]]; then
              ((count++))
              echo "[$count] Checking $script..."

              # Run with 30 second timeout
              if timeout 30s shellcheck -e SC1090 -e SC1091 -S warning "$script" >/dev/null 2>&1; then
                echo "  ✓ OK"
              else
                exit_status=$?
                if [[ $exit_status -eq 124 ]]; then
                  echo "  ⏱ TIMEOUT (skipping)"
                  ((timeout_count++))
                else
                  echo "  ✗ FAILED"
                  exit_code=1
                fi
              fi
            fi
          done

          echo ""
          echo "Checked $count scripts"
          if [[ $timeout_count -gt 0 ]]; then
            echo "⚠ Warning: $timeout_count file(s) timed out"
          fi

          if [[ $exit_code -eq 0 ]]; then
            echo "::notice::✓ All ShellCheck tests passed"
            if [[ $timeout_count -gt 0 ]]; then
              echo "::warning::$timeout_count file(s) timed out and were skipped"
            fi
          else
            echo "::error::✗ ShellCheck found issues (see details above)"
            echo "::error::To fix locally: shellcheck -e SC1090 -e SC1091 -S warning <file>"
          fi

          exit $exit_code

  syntax-check:
    name: Bash Syntax Validation
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check syntax of all shell scripts
        run: |
          echo "Bash version: $(bash --version | head -1)"
          echo "Checking syntax..."

          error_count=0
          for script in install_multi.sh lib/*.sh; do
            if [[ -f "$script" ]]; then
              if bash -n "$script" 2>&1; then
                echo "✓ $script"
              else
                echo "✗ $script - FAILED"
                ((error_count++))
              fi
            fi
          done

          if [[ $error_count -gt 0 ]]; then
            echo "::error::Found $error_count syntax error(s)"
            exit 1
          fi
          echo "✓ All scripts have valid syntax"

  code-style:
    name: Code Style & Best Practices
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for common issues
        run: |
          echo "Checking for missing set -euo pipefail..."
          MISSING_STRICT_MODE=0
          for script in lib/*.sh; do
            [[ -f "$script" ]] || continue
            if ! head -20 "$script" | grep -q 'set -'; then
              echo "::error file=$script::Missing strict mode"
              MISSING_STRICT_MODE=1
            fi
          done

          if [[ $MISSING_STRICT_MODE -eq 1 ]]; then
            exit 1
          fi
          echo "✓ All library modules have strict mode"

      - name: Check script headers
        run: |
          error_count=0
          for script in install_multi.sh lib/*.sh; do
            [[ -f "$script" ]] || continue
            if ! head -1 "$script" | grep -q '^#!/'; then
              echo "::error file=$script::Missing shebang"
              ((error_count++))
            fi
          done

          if [[ $error_count -gt 0 ]]; then
            exit 1
          fi
          echo "✓ All scripts have proper shebang lines"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security checks
        run: |
          echo "Checking for potential security issues..."

          if grep -rn 'eval.*\$' --include="*.sh" lib/; then
            echo "::error::Found unsafe eval usage"
            exit 1
          fi

          echo "✓ Security checks passed"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install test dependencies
        run: |
          echo "Installing jq..."
          sudo apt-get update -qq
          sudo apt-get install -y jq
          echo "✓ jq installed: $(jq --version)"

      - name: Run unit tests
        run: |
          echo "Running test suite..."
          echo "Test count: $(find tests/unit -name 'test_*.sh' -type f | wc -l)"
          echo ""

          if bash tests/test-runner.sh; then
            echo "::notice::✓ All tests passed"
          else
            echo "::error::✗ Tests failed (exit code: $?)"
            exit 1
          fi
