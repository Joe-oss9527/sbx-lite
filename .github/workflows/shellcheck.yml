name: ShellCheck & Code Quality

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - '**.sh'
      - 'lib/**'
      - '.github/workflows/shellcheck.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.sh'
      - 'lib/**'

jobs:
  shellcheck:
    name: ShellCheck Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display environment info
        run: |
          echo "::group::Environment Information"
          echo "Runner OS: $RUNNER_OS"
          echo "Working directory: $(pwd)"
          echo "Shell files to check:"
          find . -name "*.sh" -type f | grep -E "(install_multi|lib/)" | head -20
          echo "::endgroup::"

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          severity: warning
          ignore_paths: docs
        env:
          SHELLCHECK_OPTS: -e SC1090 -e SC1091

  syntax-check:
    name: Bash Syntax Validation
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check syntax of all shell scripts
        run: |
          echo "Bash version: $(bash --version | head -1)"
          echo "Checking syntax..."

          error_count=0
          for script in install_multi.sh lib/*.sh; do
            if [[ -f "$script" ]]; then
              if bash -n "$script" 2>&1; then
                echo "✓ $script"
              else
                echo "✗ $script - FAILED"
                ((error_count++))
              fi
            fi
          done

          if [[ $error_count -gt 0 ]]; then
            echo "::error::Found $error_count syntax error(s)"
            exit 1
          fi
          echo "✓ All scripts have valid syntax"

  code-style:
    name: Code Style & Best Practices
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for common issues
        run: |
          echo "Checking for missing set -euo pipefail..."
          MISSING_STRICT_MODE=0
          for script in lib/*.sh; do
            [[ -f "$script" ]] || continue
            if ! head -20 "$script" | grep -q 'set -'; then
              echo "::error file=$script::Missing strict mode"
              MISSING_STRICT_MODE=1
            fi
          done

          if [[ $MISSING_STRICT_MODE -eq 1 ]]; then
            exit 1
          fi
          echo "✓ All library modules have strict mode"

      - name: Check script headers
        run: |
          error_count=0
          for script in install_multi.sh lib/*.sh; do
            [[ -f "$script" ]] || continue
            if ! head -1 "$script" | grep -q '^#!/'; then
              echo "::error file=$script::Missing shebang"
              ((error_count++))
            fi
          done

          if [[ $error_count -gt 0 ]]; then
            exit 1
          fi
          echo "✓ All scripts have proper shebang lines"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security checks
        run: |
          echo "Checking for potential security issues..."

          if grep -rn 'eval.*\$' --include="*.sh" lib/; then
            echo "::error::Found unsafe eval usage"
            exit 1
          fi

          echo "✓ Security checks passed"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install test dependencies
        run: |
          echo "Installing jq..."
          sudo apt-get update -qq
          sudo apt-get install -y jq
          echo "✓ jq installed: $(jq --version)"

      - name: Run unit tests
        run: |
          echo "Running test suite..."
          echo "Test count: $(find tests/unit -name 'test_*.sh' -type f | wc -l)"
          echo ""

          if bash tests/test-runner.sh; then
            echo "::notice::✓ All tests passed"
          else
            echo "::error::✗ Tests failed (exit code: $?)"
            exit 1
          fi
