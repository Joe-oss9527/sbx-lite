# sbx-lite ä¸€é”®å®‰è£…æ”¹è¿›è®¡åˆ’ - æ‰§è¡Œæ‘˜è¦

**æ—¥æœŸ**: 2025-11-07
**æ–‡æ¡£**: åŸºäº `ONELINER_INSTALL_AUDIT.md` å’Œ `IMPROVEMENT_PLAN.md`
**ç›®æ ‡**: å°†ä¸€é”®å®‰è£…åŠŸèƒ½ä»å¯ç”¨çº§åˆ«æå‡åˆ°ç”Ÿäº§çº§åˆ«

---

## TL;DR (å¤ªé•¿ä¸çœ‹ç‰ˆ)

**ç°çŠ¶**: âœ… åŠŸèƒ½å¯ç”¨ï¼Œä½†æœ‰æ”¹è¿›ç©ºé—´
**ç›®æ ‡**: ğŸ¯ ç”Ÿäº§çº§è´¨é‡ï¼Œä¼ä¸šçº§å¯é æ€§
**æ—¶é—´**: ğŸ“… 1 å‘¨æ ¸å¿ƒæ”¹è¿› + æœªæ¥å¢å¼º
**å‚è€ƒ**: ğŸ† Rustup, Docker, Google SRE æœ€ä½³å®è·µ

---

## æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### ğŸ”´ P0 - ç«‹å³ä¿®å¤ (30åˆ†é’Ÿ)

| é—®é¢˜ | å½±å“ | è§£å†³æ–¹æ¡ˆ | å·¥ä½œé‡ |
|------|------|---------|--------|
| README URL ä¸ä¸€è‡´ | ç‰ˆæœ¬ä¸åŒæ­¥ | ç»Ÿä¸€ä¸º Joe-oss9527/sbx-lite | 5 min |
| æ— æ–‡ä»¶éªŒè¯ | å®‰å…¨é£é™© | è¯­æ³•æ£€æŸ¥ + å¤§å°æ£€æŸ¥ | 20 min |
| é”™è¯¯æ¶ˆæ¯ä¸æ¸…æ™° | ç”¨æˆ·ä½“éªŒå·® | è¯¦ç»†é”™è¯¯æç¤º + å»ºè®® | 15 min |

### ğŸŸ¡ P1 - å¯é æ€§å¢å¼º (1.5å°æ—¶)

| é—®é¢˜ | å½±å“ | è§£å†³æ–¹æ¡ˆ | å‚è€ƒ |
|------|------|---------|------|
| æ— é‡è¯•æœºåˆ¶ | ç½‘ç»œæŠ–åŠ¨å¤±è´¥ | æŒ‡æ•°é€€é¿ + æŠ–åŠ¨ | Google SRE |
| ä¸‹è½½å™¨å•ä¸€ | å…¼å®¹æ€§é—®é¢˜ | curl/wget æŠ½è±¡ | Rustup |
| æ— ç‰ˆæœ¬æ£€æŸ¥ | å…¼å®¹æ€§é”™è¯¯ | API å¥‘çº¦æ£€æŸ¥ | Design by Contract |

### ğŸŸ¢ P2 - æ€§èƒ½ä¼˜åŒ– (2å°æ—¶)

| å½“å‰æ€§èƒ½ | ä¼˜åŒ–å | æ”¹è¿› | æ–¹æ³• |
|---------|--------|------|------|
| 30s ä¸‹è½½ | 3s | **10x** | å¹¶è¡Œä¸‹è½½ (xargs -P) |
| 41s æ€»æ—¶é—´ | 15s | **2.7x** | å…¨æµç¨‹ä¼˜åŒ– |

---

## è®¾è®¡åŸåˆ™

### å‚è€ƒçš„é¡¶çº§é¡¹ç›®

#### 1. **Rustup** (Rust å®˜æ–¹å®‰è£…å™¨)
```bash
# å­¦ä¹ è¦ç‚¹
âœ“ ä¸‹è½½å™¨æŠ½è±¡ (curl/wget è‡ªåŠ¨é€‰æ‹©)
âœ“ åˆ†å±‚éªŒè¯ (æƒé™ + æ‰§è¡Œæ€§ + å…¼å®¹æ€§)
âœ“ æ¡ä»¶æ€§é‡è¯• (æ£€æµ‹æ”¯æŒåå¯ç”¨)
âœ“ å¹³å°æ£€æµ‹ç­–ç•¥
âœ“ é˜²å¾¡æ€§å‡½æ•°è®¾è®¡ (need_cmd, ensure, assert_nz)
```

#### 2. **Docker** (å®¹å™¨å®‰è£…è„šæœ¬)
```bash
# å­¦ä¹ è¦ç‚¹
âœ“ --dry-run é¢„è§ˆæ¨¡å¼
âœ“ ShellCheck é›†æˆ
âœ“ æ˜ç¡®ç”Ÿäº§ç¯å¢ƒå»ºè®®
```

#### 3. **Google SRE** (ç«™ç‚¹å¯é æ€§å·¥ç¨‹)
```bash
# æ ¸å¿ƒåŸåˆ™
âœ“ æŒ‡æ•°é€€é¿ + æŠ–åŠ¨ (é˜²æ­¢é‡è¯•é£æš´)
âœ“ é‡è¯•é¢„ç®— (æ¯è¯·æ±‚æœ€å¤š 3 æ¬¡)
âœ“ é”™è¯¯åˆ†ç±» (å¯é‡è¯• vs ä¸å¯é‡è¯•)
âœ“ é¿å…é‡è¯•æ”¾å¤§
âœ“ å…¬å¼: min(((2^n)+random_ms), max_backoff)
```

#### 4. **OWASP** (å®‰å…¨æœ€ä½³å®è·µ)
```bash
# å®‰å…¨è¦æ±‚
âœ“ å¼ºåˆ¶ HTTPS + TLS 1.2+
âœ“ æ–‡ä»¶å®Œæ•´æ€§éªŒè¯ (SHA256)
âœ“ è¾“å…¥éªŒè¯å’Œæ¸…ç†
âœ“ å®‰å…¨çš„ä¸´æ—¶æ–‡ä»¶å¤„ç†
```

### SOLID åŸåˆ™åº”ç”¨

```bash
# S - å•ä¸€èŒè´£åŸåˆ™
_detect_installation_mode()  # åªæ£€æµ‹
_download_module()           # åªä¸‹è½½
_verify_module()            # åªéªŒè¯
_load_modules()             # åè°ƒç¼–æ’

# O - å¼€é—­åŸåˆ™
GITHUB_REPO="${GITHUB_REPO:-default}"  # å¯æ‰©å±•
MAX_RETRIES="${MAX_RETRIES:-3}"

# D - ä¾èµ–å€’ç½®åŸåˆ™
download_file() {  # æŠ½è±¡å±‚
    if have curl; then _download_with_curl
    elif have wget; then _download_with_wget
    fi
}
```

---

## å…³é”®æ”¹è¿›

### 1. æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶

**Google SRE æ ‡å‡†å®ç°**:
```bash
# é‡è¯•æ—¶é—´è¡¨
Attempt 1: å¤±è´¥
Attempt 2: ç­‰å¾… 2s + (0-1s æŠ–åŠ¨) = 2-3s
Attempt 3: ç­‰å¾… 4s + (0-1s æŠ–åŠ¨) = 4-5s
Attempt 4: ç­‰å¾… 8s + (0-1s æŠ–åŠ¨) = 8-9s

# ç‰¹æ€§
âœ“ æŒ‡æ•°å¢é•¿ (2^n)
âœ“ éšæœºæŠ–åŠ¨ (é˜²æ­¢é›·é¸£ç¾¤ä½“)
âœ“ æœ€å¤§é€€é¿é™åˆ¶ (32s)
âœ“ é‡è¯•é¢„ç®— (å…¨å±€é™åˆ¶)
âœ“ é”™è¯¯åˆ†ç±» (HTTP 404 ä¸é‡è¯•)
```

**ä»£ç ç»“æ„**:
```bash
lib/retry.sh:
  - calculate_backoff()       # è®¡ç®—é€€é¿æ—¶é—´
  - retry_with_backoff()      # é€šç”¨é‡è¯•å‡½æ•°
  - is_retriable_error()      # é”™è¯¯åˆ†ç±»
  - check_retry_budget()      # å…¨å±€é¢„ç®—
```

### 2. ä¸‹è½½å™¨æŠ½è±¡å±‚

**Rustup æ¨¡å¼**:
```bash
lib/download.sh:
  - download_file()               # æŠ½è±¡æ¥å£
  - _download_with_curl()         # curl å®ç°
  - _download_with_wget()         # wget å®ç°
  - check_curl_for_retry_support() # åŠŸèƒ½æ£€æµ‹
```

**å®‰å…¨å¢å¼º**:
```bash
âœ“ å¼ºåˆ¶ HTTPS (--proto '=https')
âœ“ å¼ºåˆ¶ TLS 1.2+ (--tlsv1.2)
âœ“ è¿æ¥è¶…æ—¶ (--connect-timeout 10)
âœ“ æ€»è¶…æ—¶ (--max-time 30)
âœ“ URL éªŒè¯
```

### 3. æ–‡ä»¶å®Œæ•´æ€§éªŒè¯

**å¤šå±‚éªŒè¯**:
```bash
Phase 1 (ç«‹å³å®æ–½):
  âœ“ æ–‡ä»¶å¤§å°æ£€æŸ¥ (>100 bytes)
  âœ“ Bash è¯­æ³•éªŒè¯ (bash -n)
  âœ“ æ¨¡å—æ ‡è¯†æ£€æŸ¥ (å¤´éƒ¨æ³¨é‡Š)
  âœ“ é˜²æŠ¤å˜é‡æ£€æŸ¥

Phase 4 (æœªæ¥å¢å¼º):
  âœ“ SHA256 æ ¡éªŒå’Œ
  âœ“ GPG ç­¾åéªŒè¯
  âœ“ ç‰ˆæœ¬æ ‡ç­¾ç³»ç»Ÿ
```

### 4. å¹¶è¡Œä¸‹è½½ç³»ç»Ÿ

**æ€§èƒ½æå‡**:
```bash
# é¡ºåºä¸‹è½½
10 modules Ã— 3s = 30s

# å¹¶è¡Œä¸‹è½½ (5 jobs)
ceil(10/5) Ã— 3s = 6s

# å¹¶è¡Œä¸‹è½½ (10 jobs)
max(3s) = 3s

# æ”¹è¿›: 10x é€Ÿåº¦æå‡
```

**å®ç°æ–¹å¼**:
```bash
# xargs å¹¶è¡Œ
printf '%s\n' "${modules[@]}" | \
  xargs -P 5 -I {} download_module {}

# å›é€€æœºåˆ¶
if ! download_parallel; then
    warn "Falling back to sequential"
    download_sequential
fi
```

---

## å®æ–½è·¯çº¿å›¾

### Week 1, Day 1: P0 ä¿®å¤ (30åˆ†é’Ÿ)
```
09:00 - 09:15  ç»Ÿä¸€ README URL
09:15 - 09:35  å®ç°åŸºç¡€æ–‡ä»¶éªŒè¯
09:35 - 09:50  æ”¹è¿›é”™è¯¯æ¶ˆæ¯
09:50 - 10:30  æµ‹è¯•å’Œæäº¤
```

**äº¤ä»˜ç‰©**:
- âœ… ä¿®å¤çš„ README.md
- âœ… å¢å¼ºçš„ install_multi.sh
- âœ… æµ‹è¯•æŠ¥å‘Š

### Week 1, Day 2-3: P1 å¯é æ€§ (1.5å¤©)
```
Day 2:
  10:00 - 12:00  åˆ›å»º lib/retry.sh (é‡è¯•æœºåˆ¶)
  13:00 - 15:00  åˆ›å»º lib/download.sh (ä¸‹è½½å™¨æŠ½è±¡)
  15:00 - 16:00  é›†æˆæµ‹è¯•

Day 3:
  10:00 - 11:00  API å¥‘çº¦æ£€æŸ¥
  11:00 - 13:00  å•å…ƒæµ‹è¯• (bats)
  13:00 - 15:00  é›†æˆæµ‹è¯•
  15:00 - 16:00  æ–‡æ¡£æ›´æ–°
```

**äº¤ä»˜ç‰©**:
- âœ… lib/retry.sh (200 lines)
- âœ… lib/download.sh (150 lines)
- âœ… æµ‹è¯•å¥—ä»¶ (80% è¦†ç›–ç‡)
- âœ… æ›´æ–°çš„æ–‡æ¡£

### Week 2, Day 1-2: P2 æ€§èƒ½ (2å¤©)
```
Day 1:
  10:00 - 13:00  å¹¶è¡Œä¸‹è½½å®ç°
  13:00 - 14:00  è¿›åº¦æŒ‡ç¤º
  14:00 - 16:00  æ€§èƒ½æµ‹è¯•

Day 2:
  10:00 - 11:00  å›é€€æœºåˆ¶
  11:00 - 12:00  è¾¹ç¼˜æƒ…å†µå¤„ç†
  13:00 - 16:00  æ–‡æ¡£å’Œç¤ºä¾‹
```

**äº¤ä»˜ç‰©**:
- âœ… å¹¶è¡Œä¸‹è½½åŠŸèƒ½
- âœ… æ€§èƒ½åŸºå‡† (10x æå‡)
- âœ… å®Œæ•´æ–‡æ¡£

### Future: P3 ç”Ÿäº§çº§ (æŒ‰éœ€)
```
âœ“ SHA256 æ ¡éªŒå’Œç³»ç»Ÿ (4 hours)
âœ“ CI/CD é›†æˆ (2 hours)
âœ“ ç‰ˆæœ¬æ ‡ç­¾ (2 hours)
âœ“ Dry-run æ¨¡å¼ (2 hours)
âœ“ GPG ç­¾å (å¯é€‰, 4 hours)
```

---

## æµ‹è¯•ç­–ç•¥

### æµ‹è¯•é‡‘å­—å¡”

```
        /\
       /  \  E2E Tests (5%)
      /____\
     /      \
    / Integration  \  é›†æˆæµ‹è¯• (30%)
   /________________\
  /                  \
 /   Unit Tests       \  å•å…ƒæµ‹è¯• (65%)
/______________________\
```

### æµ‹è¯•æ¡†æ¶

**Bats-core** (Bash è‡ªåŠ¨åŒ–æµ‹è¯•ç³»ç»Ÿ):
```bash
# å®‰è£…
git clone https://github.com/bats-core/bats-core.git
./bats-core/install.sh /usr/local

# è¿è¡Œ
bats tests/unit/retry.bats
bats tests/integration/install.bats
```

### æµ‹è¯•çŸ©é˜µ

```yaml
æ“ä½œç³»ç»Ÿ:
  - Ubuntu 20.04, 22.04, 24.04
  - Debian 11, 12
  - CentOS 8
  - Alpine Linux

å®‰è£…æ¨¡å¼:
  - æœ¬åœ° (git clone)
  - è¿œç¨‹ (bash <(curl))
  - ç¯å¢ƒå˜é‡é…ç½®

åœºæ™¯:
  - å…¨æ–°å®‰è£…
  - å‡çº§äºŒè¿›åˆ¶
  - é‡æ–°é…ç½®
  - å¸è½½
  - ç½‘ç»œæ•…éšœæ¢å¤
  - éƒ¨åˆ†ä¸‹è½½æ¢å¤
```

---

## æ€§èƒ½åŸºå‡†

### å½“å‰æ€§èƒ½ vs ä¼˜åŒ–å

| æŒ‡æ ‡ | å½“å‰ | ä¼˜åŒ–å | æ”¹è¿› |
|------|------|--------|------|
| æ¨¡å—ä¸‹è½½æ—¶é—´ | 30s | 3s | **10x** â¬†ï¸ |
| æ€»å®‰è£…æ—¶é—´ | 41s | 15s | **2.7x** â¬†ï¸ |
| ç½‘ç»œæ•…éšœæ¢å¤ | âŒ å¤±è´¥ | âœ… è‡ªåŠ¨é‡è¯• | â™¾ï¸ |
| å†…å­˜ä½¿ç”¨ | ~50MB | ~80MB | 1.6x â¬†ï¸ |

### å¯é æ€§æå‡

| åœºæ™¯ | å½“å‰ | ä¼˜åŒ–å |
|------|------|--------|
| ç½‘ç»œæŠ–åŠ¨ | 100% å¤±è´¥ | 95% è‡ªåŠ¨æ¢å¤ |
| GitHub é™æµ | 100% å¤±è´¥ | 90% é‡è¯•æˆåŠŸ |
| éƒ¨åˆ†ä¸‹è½½ | å®Œå…¨å¤±è´¥ | åªé‡æ–°ä¸‹è½½å¤±è´¥éƒ¨åˆ† |
| æŸåæ–‡ä»¶ | å®‰è£…åå´©æºƒ | ä¸‹è½½æ—¶æ£€æµ‹å¹¶æ‹’ç» |

---

## å®‰å…¨å¢å¼º

### å¨èƒæ¨¡å‹

| å¨èƒ | Phase 1 | Phase 4 |
|------|---------|---------|
| MITM æ”»å‡» | HTTPS + TLS 1.2+ | + SHA256 |
| ä»“åº“æ±¡æŸ“ | è¯­æ³•éªŒè¯ | + GPG ç­¾å |
| ä¾èµ–æ··æ·† | URL éªŒè¯ | + æ ¡éªŒå’Œ |
| é‡æ”¾æ”»å‡» | - | æ—¶é—´æˆ³éªŒè¯ |

### å®‰å…¨æ¸…å•

```
[x] HTTPS å¼ºåˆ¶
[x] TLS 1.2+ å¼ºåˆ¶
[x] è¾“å…¥éªŒè¯
[x] è¯­æ³•éªŒè¯
[x] å®‰å…¨ä¸´æ—¶æ–‡ä»¶ (700)
[x] è‡ªåŠ¨æ¸…ç† (trap)
[ ] SHA256 æ ¡éªŒå’Œ (Phase 4)
[ ] GPG ç­¾å (Phase 4)
[ ] ç‰ˆæœ¬é”å®š (Phase 4)
```

---

## å‘åå…¼å®¹æ€§

### å…¼å®¹æ€§ä¿è¯

```bash
# 1. é»˜è®¤è¡Œä¸ºä¿æŒä¸å˜
# æ—§è„šæœ¬ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œ

# 2. æ–°åŠŸèƒ½é€šè¿‡ç¯å¢ƒå˜é‡é€‰æ‹©åŠ å…¥
ENABLE_PARALLEL_DOWNLOAD="${ENABLE_PARALLEL_DOWNLOAD:-1}"
ENABLE_RETRY_MECHANISM="${ENABLE_RETRY_MECHANISM:-1}"

# 3. åŠŸèƒ½å¼€å…³
LEGACY_MODE="${LEGACY_MODE:-0}"
if [[ $LEGACY_MODE -eq 1 ]]; then
    # ä½¿ç”¨æ—§è¡Œä¸º
fi

# 4. ç‰ˆæœ¬åå•†
VERSION="${VERSION:-latest}"  # ç”¨æˆ·å¯æŒ‡å®šç‰ˆæœ¬
```

### å›æ»šè®¡åˆ’

```bash
# ç´§æ€¥å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
git revert <commit>

# ç”¨æˆ·æŒ‡å®šç‰ˆæœ¬
VERSION=v2.1.0 bash <(curl -fsSL ...)
```

---

## æˆåŠŸæŒ‡æ ‡

### å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPI)

```
åŠŸèƒ½æ€§:
  âœ“ æ¨¡å—ä¸‹è½½æˆåŠŸç‡: >99.9%
  âœ“ ç½‘ç»œæ•…éšœè‡ªåŠ¨æ¢å¤: >95%
  âœ“ ä¸€é”®å®‰è£…æˆåŠŸç‡: >99%

æ€§èƒ½:
  âœ“ ä¸‹è½½æ—¶é—´: <5s (ä» 30s)
  âœ“ æ€»å®‰è£…æ—¶é—´: <20s (ä» 41s)
  âœ“ å†…å­˜ä½¿ç”¨: <100MB

è´¨é‡:
  âœ“ ShellCheck: 0 warnings
  âœ“ æµ‹è¯•è¦†ç›–ç‡: >80%
  âœ“ ä»£ç å¤æ‚åº¦: <10

ç”¨æˆ·ä½“éªŒ:
  âœ“ é”™è¯¯æ¶ˆæ¯æ¸…æ™°: 100%
  âœ“ æ–‡æ¡£å®Œæ•´: 100%
  âœ“ å‘åå…¼å®¹: 100%
```

---

## é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| xargs -P ä¸å…¼å®¹ | ä½ | ä¸­ | æ£€æµ‹ + å›é€€ |
| export -f é™åˆ¶ | ä¸­ | é«˜ | ä½¿ç”¨è„šæœ¬æ–‡ä»¶ |
| é‡è¯•å¢åŠ å»¶è¿Ÿ | ä½ | ä½ | åˆç†è¶…æ—¶ |
| ç ´åç°æœ‰ç”¨æˆ· | ä½ | é«˜ | å…¼å®¹æ€§æµ‹è¯• |

---

## å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£
1. [Rustup Installation](https://rust-lang.github.io/rustup/installation/)
2. [Docker Install Script](https://github.com/docker/docker-install)
3. [Google SRE - Handling Overload](https://sre.google/sre-book/handling-overload/)
4. [Google Cloud Retry Strategy](https://cloud.google.com/storage/docs/retry-strategy)

### æœ€ä½³å®è·µ
5. [ShellCheck](https://www.shellcheck.net/)
6. [Exponential Backoff](https://cloud.google.com/memorystore/docs/redis/exponential-backoff)
7. [OWASP Secure Coding](https://owasp.org/www-project-secure-coding-practices-quick-reference-guide/)

### å·¥å…·
8. [Bats Testing](https://github.com/bats-core/bats-core)
9. [GNU Parallel](https://www.gnu.org/software/parallel/)

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ (ä»Šå¤©)

```bash
# 1. å®¡æŸ¥æ”¹è¿›è®¡åˆ’
é˜…è¯»: IMPROVEMENT_PLAN.md (å®Œæ•´ç‰ˆ)

# 2. å¼€å§‹ Phase 1 å®æ–½
æ—¶é—´: 30 åˆ†é’Ÿ
ä¼˜å…ˆçº§: P0 (CRITICAL)

# 3. è¿è¡Œæµ‹è¯•
éªŒè¯: åŸºç¡€åŠŸèƒ½ä¸ç ´å
```

### æœ¬å‘¨è®¡åˆ’

```
Monday:    Phase 1 å®Œæˆ + æäº¤ PR
Tuesday:   Phase 2 å¼€å§‹ (é‡è¯•æœºåˆ¶)
Wednesday: Phase 2 ç»§ç»­ (ä¸‹è½½å™¨æŠ½è±¡)
Thursday:  Phase 2 æµ‹è¯•
Friday:    Phase 3 å¼€å§‹ (å¹¶è¡Œä¸‹è½½)
```

### éœ€è¦å†³ç­–

```
â“ æ˜¯å¦ç«‹å³å¼€å§‹å®æ–½ Phase 1ï¼Ÿ
â“ å¹¶è¡Œä¸‹è½½æ˜¯å¦åœ¨ v2.2.0 è¿˜æ˜¯ v3.0.0ï¼Ÿ
â“ SHA256 æ ¡éªŒæ˜¯å¦å¿…éœ€ï¼ˆå½±å“ CI/CDï¼‰ï¼Ÿ
â“ æ˜¯å¦éœ€è¦ GPG ç­¾åï¼ˆé¢å¤–å¤æ‚åº¦ï¼‰ï¼Ÿ
```

---

## è·å–å¸®åŠ©

**å®Œæ•´æ–‡æ¡£**: `IMPROVEMENT_PLAN.md` (60+ é¡µ)
**å®¡æŸ¥æŠ¥å‘Š**: `ONELINER_INSTALL_AUDIT.md` (658 è¡Œ)

**å‡†å¤‡å¥½å¼€å§‹å®æ–½äº†å—ï¼Ÿ** ğŸš€
